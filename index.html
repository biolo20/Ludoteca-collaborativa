<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ludoteca Collaborativa</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --card:#0b1224; --text:#e5e7eb; --brand:#22c55e }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1021,#0b1224 40%,#0f172a)}
    body,button,input,select,textarea{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.7);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #1f2937}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .hero{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 210deg at 50% 50%, #34d399, #22d3ee, #818cf8, #34d399); box-shadow:0 0 0 2px #0006}
    .title{font-size:1.4rem;font-weight:700}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid #334155;background:#0b1224;padding:10px 14px;border-radius:12px;cursor:pointer;text-decoration:none;color:var(--text)}
    .btn--brand{background:linear-gradient(90deg,#22c55e,#06b6d4);border:none}
    .panel{margin:18px 0;background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:12px}
    .filters{display:grid;grid-template-columns:1fr repeat(3, minmax(120px, 160px)) 120px; gap:10px}
    .filters input,.filters select{width:100%;padding:10px;border-radius:12px;border:1px solid #334155;background:#0b1224}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px; margin:16px 0 28px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid #334155;font-size:.75rem;color:var(--muted)}
    .name{font-weight:700;font-size:1.05rem}
    .muted{color:var(--muted); font-size:.9rem}
    .footer{color:#9ca3af; font-size:.85rem; padding-bottom:28px}
    .empty{border:1px dashed #334155;border-radius:16px;padding:18px;text-align:center;color:#9ca3af}
    .form-grid{display:grid;grid-template-columns:repeat(2, minmax(200px,1fr));gap:10px}
    .form-grid label{display:flex;flex-direction:column;gap:6px;font-size:.95rem}
    input,select,textarea{background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px;color:var(--text)}
    textarea{min-height:80px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px;white-space:pre-wrap}
    @media(max-width:820px){ .filters{grid-template-columns:1fr 1fr} .form-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <div class="wrap hero">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">Ludoteca Collaborativa</div>
    </div>
    <div class="actions">
      <a class="btn" id="rawLink" target="_blank" rel="noreferrer">Scarica elenco</a>
      <a class="btn btn--brand" id="addBtn" target="_blank" rel="noreferrer">➕ Suggerisci un gioco</a>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- FILTRI -->
  <section class="panel" aria-labelledby="filtriTitolo">
    <h2 id="filtriTitolo" class="muted" style="margin:6px 0 12px">Cerca e filtra</h2>
    <div class="filters">
      <input id="q" placeholder="Cerca per nome, materiale o parole chiave…" />
      <select id="eta">
        <option value="">Età</option>
        <option value="3">3+</option><option value="6">6+</option><option value="8">8+</option>
        <option value="10">10+</option><option value="12">12+</option><option value="14">14+</option>
      </select>
      <select id="num">
        <option value="">Giocatori</option>
        <option value="2-4">2–4</option><option value="4-8">4–8</option><option value="8+">8+</option>
      </select>
      <select id="durata">
        <option value="">Durata</option>
        <option value="5-10">5–10'</option><option value="10-20">10–20'</option><option value="20+">20+' </option>
      </select>
      <select id="sort">
        <option value="name">Ordina: Nome</option>
        <option value="eta">Ordina: Età</option>
        <option value="giocatori">Ordina: Giocatori</option>
      </select>
    </div>
  </section>

  <!-- LISTA -->
  <div id="count" class="muted"></div>
  <section id="grid" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" style="display:none">
    Nessun gioco trovato. Prova a cambiare i filtri oppure <a id="addLink">suggerisci un nuovo gioco</a>.
  </div>

  <!-- FORM: AGGIUNGI GIOCO -->
  <section class="panel" aria-labelledby="formTitolo">
    <h2 id="formTitolo">➕ Aggiungi un gioco (senza programmare)</h2>
    <p class="muted" style="margin-top:-6px">Compila i campi: ottieni il JSON pronto da copiare oppure apri direttamente una Issue precompilata.</p>

    <div class="form-grid">
      <label>Nome del gioco
        <input id="f_name" placeholder="Es. Palla avvelenata" required />
      </label>
      <label>Materiale necessario
        <input id="f_materiale" placeholder="Es. 1 pallone / Nessuno" />
      </label>

      <label>Età consigliata (numero)
        <input id="f_eta" type="number" min="3" step="1" placeholder="Es. 6" />
      </label>
      <label>Numero di giocatori
        <input id="f_giocatori" placeholder="Es. 4-8, 6+, 2-4" />
      </label>

      <label>Durata (minuti)
        <input id="f_durata" type="number" min="1" step="1" placeholder="Es. 10" />
      </label>
      <label>Spazio
        <select id="f_spazio">
          <option value="">—</option>
          <option>indoor</option>
          <option>outdoor</option>
          <option>indoor/outdoor</option>
        </select>
      </label>

      <label style="grid-column:1/-1">Tag (separati da virgola)
        <input id="f_tags" placeholder="palla, movimento, cooperativo" />
      </label>

      <label style="grid-column:1/-1">Descrizione breve (max ~200)
        <textarea id="f_breve" placeholder="Riassunto in una riga"></textarea>
      </label>

      <label style="grid-column:1/-1">Istruzioni sintetiche
        <textarea id="f_istruzioni" placeholder="Passaggi principali per giocare"></textarea>
      </label>

      <label style="grid-column:1/-1">Note di sicurezza
        <textarea id="f_sicurezza" placeholder="Accortezze e sicurezza"></textarea>
      </label>
    </div>

    <div class="row">
      <button class="btn btn--brand" id="genBtn" type="button">Genera JSON</button>
      <button class="btn" id="copyBtn" type="button">Copia JSON</button>
      <button class="btn" id="issueBtn" type="button">Apri Issue con questo gioco</button>
    </div>

    <div id="jsonBox" class="mono" style="margin-top:10px"></div>
  </section>

  <p class="footer">
    Questo sito legge i giochi da <code>games.json</code> nel repository.<br/>
    Le proposte inviate via Issue vengono verificate dagli admin e poi aggiunte.
  </p>
</main>

<script>
/* === CONFIG REPO === */
const GH_USER = "biolo20";
const GH_REPO = "Ludoteca-collaborativa";
/* ==================== */

const RAW_URL = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/games.json`;
const ISSUE_BASE = `https://github.com/${GH_USER}/${GH_REPO}/issues/new`;

document.getElementById("rawLink").href = RAW_URL;
document.getElementById("addLink").href = ISSUE_BASE;
document.getElementById("addBtn").href = ISSUE_BASE;

const state = { all: [], filtered: [] };

async function loadData(){
  try{
    const r = await fetch(RAW_URL, {cache:"no-store"});
    if(!r.ok) throw new Error("no games.json");
    state.all = await r.json();
  }catch(e){
    state.all = [
      {name:"Palla avvelenata", materiale:"1 pallone", eta:6, giocatori:"6+", durata:10, spazio:"outdoor", tags:["palla","movimento"], breve:"Evita di essere colpito dalla palla.", istruzioni:"Forma un cerchio; chi ha la palla cerca di colpire gli altri sotto la vita.", sicurezza:"Controlla lo spazio; niente tiri in faccia."},
      {name:"Staffetta a coppie", materiale:"Nessuno", eta:8, giocatori:"4+", durata:15, spazio:"outdoor", tags:["staffetta","gara"], breve:"Gara a coppie con percorso semplice.", istruzioni:"Prepara un percorso; ogni coppia corre a turno fino al traguardo.", sicurezza:"Rimuovi ostacoli e buche."}
    ];
  }
  render();
}

function applyFilters(){
  const q = document.getElementById("q").value.toLowerCase().trim();
  const eta = document.getElementById("eta").value;
  const num = document.getElementById("num").value;
  const dur = document.getElementById("durata").value;

  state.filtered = state.all.filter(g=>{
    const text = [g.name,g.materiale,g.breve,(g.tags||[]).join(" ")].join(" ").toLowerCase();
    if(q && !text.includes(q)) return false;
    if(eta && !(Number(g.eta)>=Number(eta))) return false;
    if(num){
      if(num==="8+" && !(String(g.giocatori).includes("8") || String(g.giocatori).includes("+"))) return false;
      if(num==="2-4" && !/^[2-4]/.test(String(g.giocatori))) return false;
      if(num==="4-8" && !/^[4-8]/.test(String(g.giocatori))) return false;
    }
    if(dur){
      const mins = Number(g.durata);
      if(dur==="5-10" && !(mins>=5 && mins<=10)) return false;
      if(dur==="10-20" && !(mins>=10 && mins<=20)) return false;
      if(dur==="20+" && !(mins>=20)) return false;
    }
    return true;
  });

  const sort = document.getElementById("sort").value;
  state.filtered.sort((a,b)=>{
    if(sort==="name") return (a.name||"").localeCompare(b.name||"",'it');
    if(sort==="eta") return (a.eta||0)-(b.eta||0);
    if(sort==="giocatori") return (a.giocatori||"").localeCompare(b.giocatori||"",'it');
    return 0;
  });
}

function render(){
  applyFilters();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  document.getElementById("count").textContent = `${state.filtered.length} giochi mostrati`;
  document.getElementById("empty").style.display = state.filtered.length? "none":"block";

  state.filtered.forEach(g=>{
    const el = document.createElement("article");
    el.className="card";
    el.innerHTML = `
      <div class="name">${g.name}</div>
      <div class="muted">${g.breve||""}</div>
      <div>
        <span class="badge">Età: ${g.eta || "n/d"}+</span>
        <span class="badge">Giocatori: ${g.giocatori||"n/d"}</span>
        <span class="badge">Durata: ${g.durata? g.durata+"'" : "n/d"}</span>
        <span class="badge">Spazio: ${g.spazio||"—"}</span>
      </div>
      <div><strong>Materiale:</strong> ${g.materiale||"Nessuno"}</div>
      ${g.istruzioni? `<details><summary>📘 Istruzioni</summary><p class="muted">${g.istruzioni}</p></details>`:""}
      ${g.sicurezza? `<details><summary>🛡️ Note di sicurezza</summary><p class="muted">${g.sicurezza}</p></details>`:""}
      ${(g.tags&&g.tags.length)? `<div class="muted">Tag: ${g.tags.map(t=>`<span class="badge">${t}</span>`).join(" ")}</div>`:""}
    `;
    grid.appendChild(el);
  });
}

/* ===== FORM ===== */
function getFormData(){
  const val = id => document.getElementById(id).value.trim();
  const toTags = s => s ? s.split(",").map(t=>t.trim()).filter(Boolean) : [];
  const obj = {
    name: val("f_name"),
    materiale: val("f_materiale"),
    eta: Number(val("f_eta")) || undefined,
    giocatori: val("f_giocatori"),
    durata: Number(val("f_durata")) || undefined,
    spazio: val("f_spazio") || undefined,
    tags: toTags(val("f_tags")),
    breve: val("f_breve"),
    istruzioni: val("f_istruzioni"),
    sicurezza: val("f_sicurezza")
  };
  return obj;
}

function validate(o){
  const errors = [];
  if(!o.name) errors.push("Nome del gioco è obbligatorio");
  if(o.eta && o.eta<3) errors.push("Età minima non valida");
  if(o.durata && o.durata<1) errors.push("Durata non valida");
  return errors;
}

function generateJSON(){
  const o = getFormData();
  const errs = validate(o);
  const box = document.getElementById("jsonBox");
  if(errs.length){
    box.textContent = "⚠️ " + errs.join(" · ");
    return null;
  }
  // rimuovi undefined
  Object.keys(o).forEach(k=> o[k]===undefined && delete o[k]);
  const json = JSON.stringify(o, null, 2);
  box.textContent = json;
  return {obj:o, json};
}

async function copyJSON(){
  const res = generateJSON();
  if(!res) return;
  try{
    await navigator.clipboard.writeText(res.json);
    alert("JSON copiato negli appunti!");
  }catch(e){
    alert("Copia non riuscita: seleziona e copia manualmente il riquadro.");
  }
}

function openIssueWithCurrent(){
  const res = generateJSON();
  if(!res) return;
  const o = res.obj;
  const title = `Nuovo gioco: ${o.name}`;
  const body =
`**Nome del gioco**: ${o.name}
**Materiale**: ${o.materiale||"—"}
**Età consigliata (numero)**: ${o.eta||"—"}
**Numero giocatori**: ${o.giocatori||"—"}
**Durata (minuti)**: ${o.durata||"—"}
**Spazio (indoor/outdoor)**: ${o.spazio||"—"}
**Descrizione breve**:
${o.breve||"—"}

**Istruzioni sintetiche**:
${o.istruzioni||"—"}

**Note di sicurezza**:
${o.sicurezza||"—"}

**Tag**: ${(o.tags||[]).join(", ") || "—"}

---
Allega qui eventuali immagini/regole aggiuntive.`;
  const url = `${ISSUE_BASE}?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
  window.open(url, "_blank", "noopener,noreferrer");
}

document.getElementById("genBtn").addEventListener("click", generateJSON);
document.getElementById("copyBtn").addEventListener("click", copyJSON);
document.getElementById("issueBtn").addEventListener("click", openIssueWithCurrent);

["q","eta","num","durata","sort"].forEach(id=>{
  document.getElementById(id).addEventListener("input", render);
  document.getElementById(id).addEventListener("change", render);
});

loadData();
</script>
</body>
</html>
